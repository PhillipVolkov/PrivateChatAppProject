<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">

    <head>
        <title>Chat App</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="static.css" rel="stylesheet"/>
    </head>
    
    <body>
    	<div class="topnav">
    		<a class="topnavElem" th:unless="${user == null}" th:text="${ user.getUsername()}"></a>
    		
    		<a class="topnavElem" th:if="${user == null}" href="/login">Login</a>
    		<a class="topnavElem" th:if="${user == null}" href="/signup">Sign Up</a>
    		<a class="topnavElem" th:unless="${user == null}" href="/logout">Logout</a>
    	</div>
    	
    	<div th:if="${user != null}" class="mainPage">
    		<div class="leftElem">
		    	<div class="card">
		    		<h1>Friends</h1>
		    		<hr class="solid">
		    		
		    		<form method="POST" th:action="@{/}" enctype="multipart/form-data">
						<label>Add a Friend: </label><input type="text" id="friendName" name="friendName" placeholder="FriendUsername">
		    		</form>
		    		
		    		<div th:if="${friendRequests.size() != 0}">
			    		<hr class="solid">
			    		<h3>Friend requests:</h3>
			    		
				   		<table>
				           <tbody>
				            <tr th:each="friend : ${friendRequests}">
				                <td th:text="${friend.getUsername()}"></td>
				            </tr>
				           </tbody>
				        </table>
			    	</div>
		    	
			    	<hr class="solid">
			    	
			    	<div class="friendFeed" id="friendFeed">
						<div th:each="friend : ${friends}">
							<div th:if="${friend.getUsername().equals(friendSelect)}">
								<button class="selected" id="selectedFriend" th:value="${friend.getUsername()}" th:text="${friend.getUsername()}" th:attr="onclick=|updateFriend(this.value)|"></button>
							</div>
							<div th:unless="${friend.getUsername().equals(friendSelect)}">
								<button th:value="${friend.getUsername()}" th:text="${friend.getUsername()}" th:attr="onclick=|updateFriend(this.value)|"></button>
							</div>
		   				</div>
	   				</div>
		    	</div>
	    	</div>
	    	
    		<div class="rightElem">
		    	<div class="card" th:if="${friends.size() != 0}">
		    		<h1>Messages</h1>
		    		<hr class="solid">
			    	<h3 th:if="${!followed}">They have NOT followed you back!</h3>
		    		<hr th:if="${!followed}" class="solid">
		    		
		    		<div class="messageFeed" id="messageFeed">
			            <div th:each="message,iter : ${messages}">
			                <div th:if="${message.getSender().equals(user.getId())}" class="messagesL">
			                	<span class="emptyMessageL"></span>
			                	<span class="yourMessage" th:text="${message.getContents()}"></span>
			                </div>
			                
			                <div th:if="${message.getSender().equals(user.getId()) && iter.index == iter.size-1}">
			                	<div th:if="${message.getRead() == null}">
		                			<p style="font-size:11px; text-align:right">Delivered</p>
		                		</div>
		                		<div th:if="${message.getRead() != null}">
		                			<div th:if="${!message.getRead()}">
		                				<p style="font-size:11px; text-align:right">Delivered</p>
		                			</div>
		                			<div th:if="${message.getRead()}">
		                				<p style="font-size:11px; text-align:right">Read</p>
		                			</div>
		                		</div>
			                </div>
			                
			                <div th:unless="${message.getSender().equals(user.getId())}" class="messagesR">
			                	<span class="thierMessage" th:text="${message.getContents()}"></span>
			                	<span class="emptyMessageR"></span>
			                </div>
			            </div>
		            </div>
			        
			        <hr class="solid">
			        <form method="POST" th:action="@{/}" enctype="multipart/form-data" id="messageForm">
			        	<div class="messageGrid">
							<textarea class="leftSideElem" style="resize: none;" id="message" name="message" placeholder="New Message:" rows=3 onkeypress="textAreaEnter(event)"></textarea>
							<button class="rightSideElem" type="submit" style="height:100%">Send</button>
						</div>
						
						<input type="hidden" name="friendSelectHidden" th:value="${friendSelect}">
		    		</form>
		    	</div>
    		</div>
    	</div>
    </body>
    
    <script th:inline="javascript">
	 	/*[+
			var user = [[${user}]];
			var friendId = [[${friendId}]];
		+]*/
		
		document.getElementById("messageFeed").scrollTop = document.getElementById("messageFeed").scrollHeight;
		document.getElementById("friendFeed").scrollTop = document.getElementById("selectedFriend").offsetTop - document.getElementById("friendFeed").offsetTop;

		function updateFriend(val) {
			location.href = '/?friendSelect=' + val;
		}
		
		function textAreaEnter(event) {
			//if (event.keyCode == 13 && !event.shiftKey) {
			//	event.preventDefault();
			//	document.getElementById("messageForm").submit();
			//}
		}
		
		var prevMsg = "";
		var sse = new EventSource('http://10.0.0.149:8081/sse');
		
		sse.onmessage = function (evt) {
			console.log(evt['data']);
			
			if (prevMsg != evt['data'] && prevMsg != "") {
				location.reload();
			}
			
			prevMsg = evt['data'];
		};
	</script>
</html>